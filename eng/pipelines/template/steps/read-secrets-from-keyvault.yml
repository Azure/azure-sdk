parameters:
- name: SecretName
  type: string
  default: ""
- name: OutputValueName  
  type: string
  default: ""
- name: ServiceConnection
  type: string
  default: "azure-sdk-github-secrets"
- name: KeyVaultName
  type: string
  default: "azure-sdk-github-secrets"

steps:
  - ${{ if or(eq(parameters.ServiceConnection, ''), eq(parameters.KeyVaultName, ''), eq(parameters.SecretName, '')) }}:
      - error: "ServiceConnection, KeyVaultName and SecretName are required parameters to the read-secrets-from-keyvault.yml template."
  - ${{ else }}:
    - task: AzureCLI@2
      displayName: Read key from Key Vault
      inputs:
        azureSubscription: 'azure-sdk-github-secrets'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          for i in {1..5}; do
            secret_value=$(az keyvault secret show --name ${{ parameters.SecretName }} --vault-name ${{ parameters.KeyVaultName }} --query value --output tsv)
            if [[ -z "$secret_value" && $i -lt 5 ]]; then
              echo "Failed to retrieve secret ${{ parameters.SecretName }} from ${{ parameters.KeyVaultName }}... Retrying after sleeping $i"
              sleep $i
            fi
          done
          if [[ -z "$secret_value" ]]; then
            echo "Failed to retrieve secret ${{ parameters.SecretName }} from ${{ parameters.KeyVaultName }}"
            exit 1
          fi
          echo "##vso[task.setvariable variable=${{ coalesce(parameters.OutputValueName, parameters.SecretName) }};issecret=true;]$secret_value"
