parameters:
- name: CommonScriptPath
  type: string
  default: ""
- name: ChangedPackagesPath
  type: string
  default: ""
- name: DefaultBranch
  type: string
  default: ""
- name: PrBranchName
  type: string
  default: "CreateOrUpdateReleaseDataFor"
- name: Repos
  type: object
  default:
    azure-sdk-for-java:
      Language: java
    azure-sdk-for-js:
      Language: js
    azure-sdk-for-net:
      Language: dotnet
    azure-sdk-for-python:
      Language: python

steps:
  - pwsh: |
      $releasePeriod = Get-Date -Format "yyyy-MM"
      Write-Host "##vso[task.setvariable variable=ReleasePeriod]$releasePeriod"
    displayName: Set Release Period Value

  - ${{ each repo in parameters.Repos }}:
    - pwsh: |
        $ErrorActionPreference = "Continue"
        log --graph --pretty=format:'%C(auto)%h%d %s %Creset%C(green)//%an %cr%Creset' -20
        git reset --hard ${{ parameters.DefaultBranch }} --
        git checkout "origin/${{ parameters.PrBranchName }}_${{ repo.value.Language }}_$(ReleasePeriod)" 2>&1 | Out-Null
        $LASTEXITCODE = 0 # This ignores any error from git checkout
        git status
      displayName: Checkout Previous PRBranch if it exist.
      workingDirectory: $(System.DefaultWorkingDirectory)/azure-sdk

    - task: PowerShell@2
      displayName: 'Generate ReleaseNotes for the Release Period'
      inputs:
        pwsh: true
        workingDirectory: $(System.DefaultWorkingDirectory)
        filePath: $(System.DefaultWorkingDirectory)/azure-sdk/eng/scripts/Generate-ReleaseNotes.ps1
        arguments: > 
          -releasePeriod $(ReleasePeriod)
          -commonScriptPath ${{ parameters.CommonScriptPath }}
          -releaseDirectory $(System.DefaultWorkingDirectory)/azure-sdk/releases
          -repoLanguage ${{ repo.value.Language }}
          -changedPackagesPath ${{ parameters.ChangedPackagesPath }}

    - template: eng/common/pipelines/templates/steps/create-pull-request.yml@azure-sdk-tools
      parameters:
        RepoName: azure-sdk
        PROwner: Azure
        BaseBranchName: ${{ parameters.DefaultBranch }}
        PRBranchName: '${{ parameters.PrBranchName }}_${{ repo.value.Language }}_$(ReleasePeriod)'
        CommitMsg: "${{ repo.value.Language }} release notes for the $(ReleasePeriod) release"
        PRTitle: "${{ repo.value.Language }} release notes for the $(ReleasePeriod) release"
        PRBody: "This is an automated pull request to gather the ${{ repo.value.Language }} release notes for the $(ReleasePeriod) release. See [Producing Release Notes](https://github.com/Azure/azure-sdk/blob/master/docs/policies/releasenotes.md#producing-release-notes) for details of the processing."
        WorkingDirectory: $(System.DefaultWorkingDirectory)/azure-sdk
        ScriptDirectory: $(System.DefaultWorkingDirectory)/azure-sdk-tools/eng/common/scripts

  - pwsh: |
      git reset --hard ${{ parameters.DefaultBranch }} --
    displayName: Reset to default branch
